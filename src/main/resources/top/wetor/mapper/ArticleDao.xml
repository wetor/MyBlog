<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.wetor.dao.ArticleDao">

    <resultMap id="articleRM" type="top.wetor.domain.Article">
        <id property="id"  column="a_id"/>
        <result property="groupId"  column="g_id"/>
        <result property="userId"  column="u_id"/>
        <result property="title"  column="a_title"/>
        <result property="tags"  column="a_tags"/>
        <result property="createTime"  column="a_create_time"/>
        <result property="modifyTime"  column="a_modify_time"/>
        <result property="lookNum"  column="a_look"/>
        <result property="loveNum"  column="a_love"/>
        <result property="cachePath"  column="a_cache_path"/>
        <result property="content"  column="a_content"/>
        <result property="isTop"  column="a_is_top"/>
        <result property="isHidden"  column="a_is_hidden"/>
        <result property="isDelete"  column="a_is_delete"/>
    </resultMap>
    <!-- TODO Article多表映射-->

    <!-- 查询公共sql -->
    <sql id="selectWithoutContent">
        select
            a_id,
            g_id,
            u_id,
            a_title,
            a_tags,
            a_create_time,
            a_modify_time,
            a_look,
            a_love,
            a_cache_path,
            a_is_top,
            a_is_hidden,
            a_is_delete
    </sql>
    <insert id="insertArticle" parameterType="top.wetor.domain.Article">
        insert into tb_article
        values( null ,
            #{groupId},
            #{userId},
            #{title},
            #{tags},
            #{createTime},
            #{modifyTime},
            #{lookNum},
            #{loveNum},
            #{cachePath},
            #{content},
            #{isTop},
            #{isHidden},
            #{isDelete}
        );
    </insert>

    <delete id="deleteArticleById" parameterType="Integer">
        delete from tb_article
        Where a_id = #{id}
    </delete>

    <update id="updateArticle" parameterType="top.wetor.domain.Article">
        update tb_article
        <set>
            <if test="groupId != null">g_id= #{groupId},</if>
            <if test="userId != null">u_id=  #{userId},</if>
            <if test="title != null">a_title=#{title},</if>
            <if test="tags != null">a_tags=#{tags},</if>
            <if test="createTime != null">a_create_time=  #{createTime},</if>
            <if test="modifyTime != null">a_modify_time= #{modifyTime},</if>
            <if test="lookNum != null">a_look=  #{lookNum},</if>
            <if test="loveNum != null">a_love=#{loveNum},</if>
            <if test="cachePath != null">a_cache_path=#{cachePath},</if>
            <if test="content != null">a_content=  #{content},</if>
            <if test="isTop != null">a_is_top= #{isTop},</if>
            <if test="isHidden != null">a_is_hidden=  #{isHidden},</if>
            <if test="isDelete != null">a_is_delete=#{isDelete}</if>

        </set>
        where a_id = #{id}
    </update>

    <select id="selectArticleById" parameterType="Integer" resultMap="articleRM">
        select * from tb_article
        where a_id = #{id}
    </select>
    <select id="selectArticleCount" resultType="integer">
        select count(*) from tb_article
    </select>


    <select id="selectArticlePage" resultMap="articleRM">
        <include refid="selectWithoutContent"/>
        <if test="param3==null or param3==0">
        </if>
        <if test="param3==1">
            ,substr(a_content,1,256)
        </if>
        <if test="param3==2">
            ,a_content
        </if>
        from tb_article
        ORDER BY a_create_time
        <if test=" param4 == null or param4 == false ">
            desc
        </if>
        limit #{begin},#{number}
    </select>



    <select id="selectArticleAll" resultMap="articleRM">
        <include refid="selectWithoutContent"/>
        <if test="param1==null or param1==0">
        </if>
        <if test="param1==1">
            ,substr(a_content,1,256)
        </if>
        <if test="param1==2">
            ,a_content
        </if>
        from tb_article
        ORDER BY a_create_time
        <if test=" param2 == null or param2 == false ">
            desc
        </if>
    </select>
    <select id="selectArticleAllByType" resultMap="articleRM">
        <include refid="selectWithoutContent"/>
        <!-- null/0:极简(不含文章内容) 1:简略(含文章内容摘要) 2:完整(包含文章内容) -->
        <if test="param3==null or param3==0">
        </if>
        <if test="param3==1">
            ,substr(a_content,1,256)
        </if>
        <if test="param3==2">
            ,a_content
        </if>
        from tb_article
        <!-- 0:User  1:Group  2:Tag -->
        <trim prefix="where" prefixOverrides="and">
            <if test="param1==0">
                and u_id=#{id}
            </if>
            <if test="param1==1">
                and g_id=#{id}
            </if>
            <if test="param1==2">
                and find_in_set(
                    (select t_content
                    from tb_tag
                    where t_id=#{id}
                ),a_tags)
            </if>
        </trim>
        ORDER BY a_create_time
        <if test=" param4 == null or param4 == false ">
            desc
        </if>
    </select>

    <select id="selectArticlePageByType" resultMap="articleRM">
        <include refid="selectWithoutContent"/>
        <!-- null/0:极简(不含文章内容) 1:简略(含文章内容摘要) 2:完整(包含文章内容) -->
        <if test="param5==null or param5==0">
        </if>
        <if test="param5==1">
            ,substr(a_content,1,256)
        </if>
        <if test="param5==2">
            ,a_content
        </if>
        from tb_article
        <!-- 0:User  1:Group  2:Tag -->
        <trim prefix="where" prefixOverrides="and">
            <if test="param1==0">
                and u_id=#{id}
            </if>
            <if test="param1==1">
                and g_id=#{id}
            </if>
            <if test="param1==2">
                and find_in_set(
                (select t_content
                from tb_tag
                where t_id=#{id}
                ),a_tags)
            </if>
        </trim>
        ORDER BY a_create_time
        <if test=" param6 == null or param6 == false ">
            desc
        </if>
        limit #{begin},#{number}
    </select>
</mapper>