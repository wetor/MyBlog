<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.wetor.dao.ArticleDao">

    <resultMap id="articleRM" type="top.wetor.domain.Article">
        <id property="id"  column="a_id"/>
        <result property="groupId"  column="g_id"/>
        <result property="userId"  column="u_id"/>
        <result property="title"  column="a_title"/>
        <result property="tags"  column="a_tags"/>
        <result property="createTime"  column="a_create_time"/>
        <result property="modifyTime"  column="a_modify_time"/>
        <result property="lookNum"  column="a_look"/>
        <result property="loveNum"  column="a_love"/>
        <result property="cachePath"  column="a_cache_path"/>
        <result property="content"  column="a_content"/>
        <result property="isTop"  column="a_is_top"/>
        <result property="isHidden"  column="a_is_hidden"/>
        <result property="isDelete"  column="a_is_delete"/>
    </resultMap>
    <!-- TODO Article多表映射-->

    <!-- 查询 文章 -->
    <sql id="selectHead">
        select
            a_id,
            g_id,
            u_id,
            a_title,
            a_tags,
            a_create_time,
            a_modify_time,
            a_look,
            a_love,
            a_cache_path,
        <if test="contentShow==0">
        </if>
        <if test="contentShow==1">
            substr(a_content,1,256),
        </if>
        <if test="contentShow==2">
            a_content,
        </if>
            a_is_top,
            a_is_hidden,
            a_is_delete
    </sql>
    <!-- 查询 排序 -->
    <sql id="selectAsc">
        ORDER BY a_is_top desc,a_create_time
        <if test=" asc == null or asc == false ">
            desc
        </if>
    </sql>
    <!-- 查询 状态-->
    <sql id="selectState">
        <trim prefixOverrides="and">
            <!-- 仅普通，置顶，隐藏，删除（回收站），普通和置顶（user），普通置顶隐藏（admin） -->
            <if test="stateShow==null">
                <!--强制为空-->
                and 1=0
            </if>
            <if test="stateShow==0">
                and (a_is_top    = 0 or a_is_top    is null)
                and (a_is_hidden = 0 or a_is_hidden is null)
                and (a_is_delete = 0 or a_is_delete is null)
            </if>
            <if test="stateShow==1">
                and a_is_top    = 1
                and (a_is_delete = 0 or a_is_delete is null)
            </if>
            <if test="stateShow==2">
                and a_is_hidden = 1
                and (a_is_delete = 0 or a_is_delete is null)
            </if>
            <if test="stateShow==3">
                and a_is_delete = 1
            </if>
            <if test="stateShow==4">
                and (a_is_delete = 0 or a_is_delete is null)
                and (a_is_hidden = 0 or a_is_hidden is null)
            </if>
            <if test="stateShow==5">
                and (a_is_delete = 0 or a_is_delete is null)
            </if>
        </trim>
    </sql>

    <sql id="selectBean">
        <!-- 0:User  1:Group  2:Tag -->
        <trim prefixOverrides="and">
            <if test="bean==0">
                and u_id=#{id}
            </if>
            <if test="bean==1">
                and g_id=#{id}
            </if>
            <if test="bean==2">
                and find_in_set(
                    (
                        select t_content
                        from tb_tag
                        where t_id=#{id}
                    ),a_tags
                )
            </if>
        </trim>
    </sql>
    <insert id="insertArticle" parameterType="top.wetor.domain.Article">
        insert into tb_article
        values(
        <trim prefixOverrides=",">
            null ,
            #{groupId},
            #{userId},
            #{title},
            #{tags},
            #{createTime},
            #{modifyTime},
            #{lookNum},
            #{loveNum},
            #{cachePath},
            #{content}
            <if test="isTop!=null">
                ,#{isTop}
            </if>
            <if test="isTop==null">
                ,0
            </if>
            <if test="isHidden!=null">
                ,#{isHidden}
            </if>
            <if test="isHidden==null">
                ,0
            </if>
            <if test="isDelete!=null">
                ,#{isDelete}
            </if>
            <if test="isDelete==null">
                ,0
            </if>
        </trim>
        );
    </insert>

    <delete id="deleteArticleById" parameterType="Integer">
        delete from tb_article
        Where a_id = #{id}
    </delete>

    <update id="updateArticle" parameterType="top.wetor.domain.Article">
        update tb_article
        <set>
            <if test="groupId != null">g_id= #{groupId},</if>
            <if test="userId != null">u_id=  #{userId},</if>
            <if test="title != null">a_title=#{title},</if>
            <if test="tags != null">a_tags=#{tags},</if>
            <if test="createTime != null">a_create_time=  #{createTime},</if>
            <if test="modifyTime != null">a_modify_time= #{modifyTime},</if>
            <if test="lookNum != null">a_look=  #{lookNum},</if>
            <if test="loveNum != null">a_love=#{loveNum},</if>
            <if test="cachePath != null">a_cache_path=#{cachePath},</if>
            <if test="content != null">a_content=  #{content},</if>
            <if test="isTop != null">a_is_top= #{isTop},</if>
            <if test="isHidden != null">a_is_hidden=  #{isHidden},</if>
            <if test="isDelete != null">a_is_delete=#{isDelete}</if>
        </set>
        where a_id = #{id}
    </update>

    <select id="selectArticleById" resultMap="articleRM">
        <include refid="selectHead"/>
        from tb_article
        where a_id = #{id}

    </select>


    <select id="selectNextArticleId" resultType="Integer">
        SELECT auto_increment FROM information_schema.tables
        where table_schema=(
            select database()
        ) and table_name="tb_article";
    </select>

    <select id="selectArticleCount" resultType="Integer">
        select count(a_id) from tb_article
        where
        <include refid="selectState"/>
    </select>


    <select id="selectArticlePage" resultMap="articleRM">
        <include refid="selectHead"/>
        from tb_article
        where
        <include refid="selectState"/>
        <include refid="selectAsc"/>
        limit #{begin},#{number}
    </select>

    <select id="selectArticleAll" resultMap="articleRM">
        <include refid="selectHead"/>
        from tb_article
        where
        <include refid="selectState"/>
        <include refid="selectAsc"/>
    </select>
    <select id="selectArticleAllByType" resultMap="articleRM">
        <include refid="selectHead"/>
        from tb_article
        where
        <include refid="selectBean"/>
        and
        <include refid="selectState"/>
        <include refid="selectAsc"/>
    </select>

    <select id="selectArticlePageByType" resultMap="articleRM">
        <include refid="selectHead"/>
        from tb_article
        where
        <include refid="selectBean"/>
        and
        <include refid="selectState"/>
        <include refid="selectAsc"/>
        limit #{begin},#{number}
    </select>
</mapper>