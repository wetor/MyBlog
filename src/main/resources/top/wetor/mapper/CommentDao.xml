<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.wetor.dao.CommentDao">

    <resultMap id="comment" type="top.wetor.domain.Comment">
        <id property="id" column="c_id"/>
        <result property="commentId" column="c_cid"/>
        <result property="articleId" column="a_id"/>
        <result property="time" column="c_time"/>
        <result property="name" column="c_name"/>
        <result property="mail" column="c_mail"/>
        <result property="content" column="c_content"/>
    </resultMap>
    <resultMap id="commentRM" type="top.wetor.domain.Comment">
        <id property="id" column="c_id"/>
        <result property="commentId" column="c_cid"/>
        <result property="articleId" column="a_id"/>
        <result property="time" column="c_time"/>
        <result property="name" column="c_name"/>
        <result property="mail" column="c_mail"/>
        <result property="content" column="c_content"/>
        <collection property="commentList" select="selectCommentTreeById_private" column="c_id"></collection>
    </resultMap>

    <insert id="insertComment" parameterType="top.wetor.domain.Comment">
        insert into tb_comment
        values( null ,
            #{commentId},
            #{articleId},
            #{time},
            #{name},
            #{mail},
            #{content}
        )
    </insert>
    <delete id="deleteCommentById" parameterType="Integer">
        delete from tb_comment
        where c_id=#{id} and
        not exists(
            select a.c_cid from(
                select b.c_cid from tb_comment b
                where b.c_cid=#{id}
            ) a
        );
        update tb_comment set c_content='此评论已被删除。'
        where c_id=#{id} and
        exists(
            select a.c_cid from(
                select b.c_cid from tb_comment b
                where b.c_cid=#{id}
            ) a
        );
    </delete>
    <update id="updateComment" parameterType="top.wetor.domain.Comment">
        update tb_comment
        <set>
            <if test="commentId!=null">c_cid=#{commentId},</if>
            <if test="articleId!=null">a_id=#{articleId},</if>
            <if test="time!=null">c_time=#{time},</if>
            <if test="name!=null">c_name=#{name},</if>
            <if test="mail!=null">a_id=#{mail},</if>
            <if test="content!=null">c_content=#{content},</if>
        </set>
        where c_id = #{id}
    </update>
    <select id="selectCommentById" parameterType="Integer" resultMap="comment">
        select * from tb_comment
        where c_id = #{id}
    </select>
    <select id="selectCommentTreeById" parameterType="Integer" resultMap="commentRM">
        select * from tb_comment
        where c_id = #{id}
    </select>
    <select id="selectCommentCount" resultType="integer">
        select count(*) from tb_comment
    </select>
    <!--子回复，默认正序-->
    <select id="selectCommentTreeById_private"  parameterType="Integer" resultMap="commentRM">
        select * from tb_comment where c_cid=#{id}
        ORDER BY c_time
    </select>

    <select id="selectCommentPage" resultMap="comment">
        select * from tb_comment
        ORDER BY c_time
        <if test=" asc == null or asc == false ">
            desc
        </if>
        limit #{begin},#{number}
    </select>

    <select id="selectCommentAll" resultMap="comment">
        select * from tb_comment
        ORDER BY c_time
        <if test=" asc == null or asc == false ">
            desc
        </if>
    </select>

    <select id="selectCommentPageByArticleId" resultMap="commentRM">
        select * from tb_comment a
        where a.c_cid is null and a.c_id in (
            select b.c_id from tb_comment b
            where b.a_id=#{id}
        )ORDER BY a.c_time
        <if test=" asc == null or asc == false ">
            desc
        </if>
        limit #{begin},#{number}
    </select>


    <select id="selectCommentAllByArticleId" resultMap="commentRM">
        select * from tb_comment a
        where a.c_cid is null and a.c_id in (
            select b.c_id from tb_comment b
            where b.a_id=#{id}
        )ORDER BY a.c_time
        <if test=" asc == null or asc == false ">
            desc
        </if>
    </select>
</mapper>